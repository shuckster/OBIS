(()=>{var Te=Object.create,dt=Object.defineProperty,Ee=Object.getPrototypeOf,ye=Object.prototype.hasOwnProperty,be=Object.getOwnPropertyNames,ve=Object.getOwnPropertyDescriptor;var Ae=t=>dt(t,"__esModule",{value:!0});var wt=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var Ne=(t,e,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of be(e))!ye.call(t,r)&&r!=="default"&&dt(t,r,{get:()=>e[r],enumerable:!(n=ve(e,r))||n.enumerable});return t},Mt=t=>Ne(Ae(dt(t!=null?Te(Ee(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var Qt=wt((sr,Wt)=>{Wt.exports={seconds:tn,makeDebouncer:at,makeThrottler:nn,runAfter:rn,runOnce:on,runFnPeriodically:Xt,makeValueChangeDetector:Pt,makeValueInPredicateDetector:an,runFnWhenValueChanges:sn,Delay:en};function tn(t){return t*1e3}function en(t,e){let[n]=at(e,t);return(...r)=>n(...r)}function at(t,e){let n,r=()=>clearTimeout(n);return[(...a)=>{r(),n=setTimeout(e,t,...a)},r]}function nn(t,e){let n=!0,[r,o]=at(e,()=>n=!0);return[(...s)=>{n&&(n=!1,r(),t(...s))},o]}function rn(t,e){let[n,r]=at(t,e);return n(),r}function on(t){let e=!0,n=()=>!0,r=(...o)=>{e&&n()&&(e=!1,t(...o))};return r.when=o=>(n=o,r),r}function Xt(t,e=16){let n=()=>clearInterval(r),r=setInterval(t,e,{cleanup:n});return n}function Pt({onChange:t=()=>{},getValueFn:e=()=>NaN,equalityFn:n=(r,o)=>r===o}){let r=e();return(...a)=>{let s=e();if(!n(s,r)){let i=r;r=s,t(s,i,...a)}}}function an({onChange:t=()=>{},getValueFn:e=()=>NaN,predicateFn:n=()=>!0}){return Pt({getValueFn:e,onChange:o=>n(o)&&t()})}function sn({fn:t,getValueFn:e}){let n=Pt({getValueFn:e,onChange:t});return Xt(n,16)}});var Rt=wt((ir,Zt)=>{Zt.exports={isThennable:un,makePromise:K,delay:dn,unzip:cn,makeIdleDetectorWithTimeout:ln,poolPromises:fn,runPromisesInSequence:pn};var{seconds:mn,runOnce:hn,makeDebouncer:te}=Qt();function ee(){return[(t,[e,n])=>[[...t[0],e],[...t[1],n]],[[],[]]]}function cn(t){return t.reduce(...ee())}function un(t){return t&&typeof t.then=="function"}function K(){let t,e;return[new Promise((r,o)=>{t=r,e=o}),t,e]}function dn(t){let[e,n]=K();return setTimeout(n,t||0),e}function ln(t=()=>{},{withinMs:e=500,timeoutInMs:n=mn(5)}){let[r,o,a]=K(),[s,i]=te(o,e),[c,u]=te(a,n),f=t(s);return s(),c(),r.finally(()=>{f&&f(),i(),u()})}function fn(t,...e){let n=()=>a.forEach(s=>s()),r=gn(t,n),[o,a]=e.map(s=>Sn(r,s)).reduce(...ee());return n(),Promise.allSettled(o)}function Sn(t,e){let{allowedToStartNext:n,bumpRunCount:r,unbump:o}=t,[a,s,i]=K();return[a,hn(()=>{r(),e().then(s,i).finally(o)}).when(n)]}function gn(t,e){let n=0;return{allowedToStartNext:()=>n<Math.max(1,t),bumpRunCount:()=>e(++n),unbump:()=>e(--n)}}function pn(t,...e){let[n,r,o]=K();return e.reduce(Tn(o),Promise.resolve(t)).then(r).catch(o),n}function Tn(t){return(e,n)=>e.then(n,t)}});var l={FIRST_RUN:"first-run",STORE_HYDRATED:"ui/store-hydrated",STORE_UPDATED:"ui/store-updated",ui:{RENDERING:"ui/rendering",RENDERED:"ui/rendered",TOGGLE_OPEN:"ui/toggle-open",FIND_ACCOUNTS:"ui/find-accounts",FIND_STATEMENTS:"ui/find-statements",VIEW_STATEMENTS:"ui/view-statements",DOWNLOAD_STATEMENTS:"ui/download-statements",DOWNLOADED_STATEMENTS:"ui/downloaded-statements",UPDATE_PROGRESS_BAR:"ui/update-progress-bar",STATEMENTS_WINDOW_READY:"ui/statements-window-ready",STATEMENTS_WINDOW_CLOSED:"ui/statements-window-closed",CLOSE_STATEMENTS_WINDOW:"ui/close-statements-window",CHANGE_STATEMENT:"ui/change-statement"},get:{ACCOUNTS:"get/accounts",STATEMENTS:"get/statements",ENTRIES:"get/entries"},error:{ACCOUNTS:"error/accounts",STATEMENTS:"error/statements",ENTRIES:"error/entries"},got:{ACCOUNTS:"got/accounts",STATEMENTS:"got/statements",ENTRIES:"got/entries"},add:{ACCOUNTS:"add/accounts",STATEMENTS:"add/statements",ENTRIES:"add/entries"},update:{ACCOUNTS:"update/accounts",STATEMENTS:"update/statements",ENTRIES:"update/entries"}};function O(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];if(!1)var o,a;throw Error("[Immer] minified error nr: "+t+(n.length?" "+n.map(function(s){return"'"+s+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function B(t){return!!t&&!!t[N]}function k(t){return!!t&&(function(e){if(!e||typeof e!="object")return!1;var n=Object.getPrototypeOf(e);if(n===null)return!0;var r=Object.hasOwnProperty.call(n,"constructor")&&n.constructor;return typeof r=="function"&&Function.toString.call(r)===De}(t)||Array.isArray(t)||!!t[_t]||!!t.constructor[_t]||lt(t)||ft(t))}function Y(t,e,n){n===void 0&&(n=!1),L(t)===0?(n?Object.keys:pt)(t).forEach(function(r){n&&typeof r=="symbol"||e(r,t[r],t)}):t.forEach(function(r,o){return e(o,r,t)})}function L(t){var e=t[N];return e?e.i>3?e.i-4:e.i:Array.isArray(t)?1:lt(t)?2:ft(t)?3:0}function mt(t,e){return L(t)===2?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function Ce(t,e){return L(t)===2?t.get(e):t[e]}function jt(t,e,n){var r=L(t);r===2?t.set(e,n):r===3?(t.delete(e),t.add(n)):t[e]=n}function Ie(t,e){return t===e?t!==0||1/t==1/e:t!=t&&e!=e}function lt(t){return Oe&&t instanceof Map}function ft(t){return Pe&&t instanceof Set}function U(t){return t.o||t.t}function ht(t){if(Array.isArray(t))return Array.prototype.slice.call(t);var e=Re(t);delete e[N];for(var n=pt(e),r=0;r<n.length;r++){var o=n[r],a=e[o];a.writable===!1&&(a.writable=!0,a.configurable=!0),(a.get||a.set)&&(e[o]={configurable:!0,writable:!0,enumerable:a.enumerable,value:t[o]})}return Object.create(Object.getPrototypeOf(t),e)}function St(t,e){return e===void 0&&(e=!1),gt(t)||B(t)||!k(t)||(L(t)>1&&(t.set=t.add=t.clear=t.delete=xe),Object.freeze(t),e&&Y(t,function(n,r){return St(r,!0)},!0)),t}function xe(){O(2)}function gt(t){return t==null||typeof t!="object"||Object.isFrozen(t)}function P(t){var e=we[t];return e||O(18,t),e}function kt(){return z}function Tt(t,e){e&&(P("Patches"),t.u=[],t.s=[],t.v=e)}function X(t){Et(t),t.p.forEach(Me),t.p=null}function Et(t){t===z&&(z=t.l)}function Ut(t){return z={p:[],l:z,h:t,m:!0,_:0}}function Me(t){var e=t[N];e.i===0||e.i===1?e.j():e.g=!0}function yt(t,e){e._=e.p.length;var n=e.p[0],r=t!==void 0&&t!==n;return e.h.O||P("ES5").S(e,t,r),r?(n[N].P&&(X(e),O(4)),k(t)&&(t=Q(e,t),e.l||Z(e,t)),e.u&&P("Patches").M(n[N],t,e.u,e.s)):t=Q(e,n,[]),X(e),e.u&&e.v(e.u,e.s),t!==Ft?t:void 0}function Q(t,e,n){if(gt(e))return e;var r=e[N];if(!r)return Y(e,function(a,s){return Bt(t,r,e,a,s,n)},!0),e;if(r.A!==t)return e;if(!r.P)return Z(t,r.t,!0),r.t;if(!r.I){r.I=!0,r.A._--;var o=r.i===4||r.i===5?r.o=ht(r.k):r.o;Y(r.i===3?new Set(o):o,function(a,s){return Bt(t,r,o,a,s,n)}),Z(t,o,!1),n&&t.u&&P("Patches").R(r,n,t.u,t.s)}return r.o}function Bt(t,e,n,r,o,a){if(B(o)){var s=Q(t,o,a&&e&&e.i!==3&&!mt(e.D,r)?a.concat(r):void 0);if(jt(n,r,s),!B(s))return;t.m=!1}if(k(o)&&!gt(o)){if(!t.h.F&&t._<1)return;Q(t,o),e&&e.A.l||Z(t,o)}}function Z(t,e,n){n===void 0&&(n=!1),t.h.F&&t.m&&St(e,n)}function bt(t,e){var n=t[N];return(n?U(n):t)[e]}function Lt(t,e){if(e in t)for(var n=Object.getPrototypeOf(t);n;){var r=Object.getOwnPropertyDescriptor(n,e);if(r)return r;n=Object.getPrototypeOf(n)}}function vt(t){t.P||(t.P=!0,t.l&&vt(t.l))}function At(t){t.o||(t.o=ht(t.t))}function Nt(t,e,n){var r=lt(e)?P("MapSet").N(e,n):ft(e)?P("MapSet").T(e,n):t.O?function(o,a){var s=Array.isArray(o),i={i:s?1:0,A:a?a.A:kt(),P:!1,I:!1,D:{},l:a,t:o,k:null,o:null,j:null,C:!1},c=i,u=tt;s&&(c=[i],u=et);var f=Proxy.revocable(c,u),m=f.revoke,S=f.proxy;return i.k=S,i.j=m,S}(e,n):P("ES5").J(e,n);return(n?n.A:kt()).p.push(r),r}function _e(t){return B(t)||O(22,t),function e(n){if(!k(n))return n;var r,o=n[N],a=L(n);if(o){if(!o.P&&(o.i<4||!P("ES5").K(o)))return o.t;o.I=!0,r=Gt(n,a),o.I=!1}else r=Gt(n,a);return Y(r,function(s,i){o&&Ce(o.t,s)===i||jt(r,s,e(i))}),a===3?new Set(r):r}(t)}function Gt(t,e){switch(e){case 2:return new Map(t);case 3:return Array.from(t)}return ht(t)}var Vt,z,Dt=typeof Symbol!="undefined"&&typeof Symbol("x")=="symbol",Oe=typeof Map!="undefined",Pe=typeof Set!="undefined",qt=typeof Proxy!="undefined"&&Proxy.revocable!==void 0&&typeof Reflect!="undefined",Ft=Dt?Symbol.for("immer-nothing"):((Vt={})["immer-nothing"]=!0,Vt),_t=Dt?Symbol.for("immer-draftable"):"__$immer_draftable",N=Dt?Symbol.for("immer-state"):"__$immer_state",Pn=typeof Symbol!="undefined"&&Symbol.iterator||"@@iterator";var De=""+Object.prototype.constructor,pt=typeof Reflect!="undefined"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Object.getOwnPropertyNames,Re=Object.getOwnPropertyDescriptors||function(t){var e={};return pt(t).forEach(function(n){e[n]=Object.getOwnPropertyDescriptor(t,n)}),e},we={},tt={get:function(t,e){if(e===N)return t;var n=U(t);if(!mt(n,e))return function(o,a,s){var i,c=Lt(a,s);return c?"value"in c?c.value:(i=c.get)===null||i===void 0?void 0:i.call(o.k):void 0}(t,n,e);var r=n[e];return t.I||!k(r)?r:r===bt(t.t,e)?(At(t),t.o[e]=Nt(t.A.h,r,t)):r},has:function(t,e){return e in U(t)},ownKeys:function(t){return Reflect.ownKeys(U(t))},set:function(t,e,n){var r=Lt(U(t),e);if(r==null?void 0:r.set)return r.set.call(t.k,n),!0;if(!t.P){var o=bt(U(t),e),a=o==null?void 0:o[N];if(a&&a.t===n)return t.o[e]=n,t.D[e]=!1,!0;if(Ie(n,o)&&(n!==void 0||mt(t.t,e)))return!0;At(t),vt(t)}return t.o[e]===n&&typeof n!="number"||(t.o[e]=n,t.D[e]=!0,!0)},deleteProperty:function(t,e){return bt(t.t,e)!==void 0||e in t.t?(t.D[e]=!1,At(t),vt(t)):delete t.D[e],t.o&&delete t.o[e],!0},getOwnPropertyDescriptor:function(t,e){var n=U(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r&&{writable:!0,configurable:t.i!==1||e!=="length",enumerable:r.enumerable,value:n[e]}},defineProperty:function(){O(11)},getPrototypeOf:function(t){return Object.getPrototypeOf(t.t)},setPrototypeOf:function(){O(12)}},et={};Y(tt,function(t,e){et[t]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}}),et.deleteProperty=function(t,e){return tt.deleteProperty.call(this,t[0],e)},et.set=function(t,e,n){return tt.set.call(this,t[0],e,n,t[0])};var je=function(){function t(n){var r=this;this.O=qt,this.F=!0,this.produce=function(o,a,s){if(typeof o=="function"&&typeof a!="function"){var i=a;a=o;var c=r;return function(g){var E=this;g===void 0&&(g=i);for(var h=arguments.length,p=Array(h>1?h-1:0),y=1;y<h;y++)p[y-1]=arguments[y];return c.produce(g,function(R){var v;return(v=a).call.apply(v,[E,R].concat(p))})}}var u;if(typeof a!="function"&&O(6),s!==void 0&&typeof s!="function"&&O(7),k(o)){var f=Ut(r),m=Nt(r,o,void 0),S=!0;try{u=a(m),S=!1}finally{S?X(f):Et(f)}return typeof Promise!="undefined"&&u instanceof Promise?u.then(function(g){return Tt(f,s),yt(g,f)},function(g){throw X(f),g}):(Tt(f,s),yt(u,f))}if(!o||typeof o!="object")return(u=a(o))===Ft?void 0:(u===void 0&&(u=o),r.F&&St(u,!0),u);O(21,o)},this.produceWithPatches=function(o,a){return typeof o=="function"?function(c){for(var u=arguments.length,f=Array(u>1?u-1:0),m=1;m<u;m++)f[m-1]=arguments[m];return r.produceWithPatches(c,function(S){return o.apply(void 0,[S].concat(f))})}:[r.produce(o,a,function(c,u){s=c,i=u}),s,i];var s,i},typeof(n==null?void 0:n.useProxies)=="boolean"&&this.setUseProxies(n.useProxies),typeof(n==null?void 0:n.autoFreeze)=="boolean"&&this.setAutoFreeze(n.autoFreeze)}var e=t.prototype;return e.createDraft=function(n){k(n)||O(8),B(n)&&(n=_e(n));var r=Ut(this),o=Nt(this,n,void 0);return o[N].C=!0,Et(r),o},e.finishDraft=function(n,r){var o=n&&n[N],a=o.A;return Tt(a,r),yt(void 0,a)},e.setAutoFreeze=function(n){this.F=n},e.setUseProxies=function(n){n&&!qt&&O(20),this.O=n},e.applyPatches=function(n,r){var o;for(o=r.length-1;o>=0;o--){var a=r[o];if(a.path.length===0&&a.op==="replace"){n=a.value;break}}var s=P("Patches").$;return B(n)?s(n,r):this.produce(n,function(i){return s(i,r.slice(o+1))})},t}(),D=new je,G=D.produce,Rn=D.produceWithPatches.bind(D),xn=D.setAutoFreeze.bind(D),wn=D.setUseProxies.bind(D),Mn=D.applyPatches.bind(D),_n=D.createDraft.bind(D),jn=D.finishDraft.bind(D);(function(){if(typeof window.CustomEvent=="function")return!1;function t(e,n){n=n||{bubbles:!1,cancelable:!1,detail:null};let r=document.createEvent("CustomEvent");return r.initCustomEvent(e,n.bubbles,n.cancelable,n.detail),r}window.CustomEvent=t})();var x=function(){let t;try{t=window}catch(c){t=self}let e="message-bus",n=new Map;function r(c,...u){let f={eventName:c,args:u,timestamp:Date.now()},m=new CustomEvent(e,{detail:f});t.dispatchEvent(m)}function o(c,u){if(typeof u!="function")throw new TypeError("Callback is not a function");let f=n.has(c)?n.get(c):n.set(c,new Map).get(c);if(f.has(u))throw new Error("Callback already deals with this event");let m=typeof c=="string"&&c.indexOf("*")===-1,S=typeof c=="string"?s(c):c instanceof RegExp?c:null;if(S===null){let E="Could not figure-out eventNameOrPattern";throw new Error(`${E} = ${c}`)}let g=E=>{let{eventName:h,args:p}=E.detail;S.test(h)&&(m?u(...p):u(h,...p))};return f.set(u,g),t.addEventListener(e,g),()=>a(c,u)}function a(c,u){if(typeof u!="function")throw new TypeError("Callback is not a function");if(!n.has(c))throw new Error("No event-listener for that name/pattern");let f=n.get(c);if(!f.has(u))throw new Error("Event callback not found for name/pattern");let m=f.get(u);t.removeEventListener(e,m),f.delete(u)}function s(c){if(!c.length)throw new Error("String should not be empty");let u=c.split("*").map(m=>m.trim()).map(i),f=u.join(".*");return u.length===1?f=`^${f}$`:(u[0]!==""&&(f=`^${f}`),u[u.length-1]!==""&&(f=`${f}$`)),new RegExp(f)}function i(c){return c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return{emit:r,on:o,off:a}}();function ke(t){return nt(t)&&w(t.emit)&&(w(t.addListener)||w(t.on))&&(w(t.removeListener)||w(t.off))}ke.displayName="isEventEmitter";function b(t){return t==null}Ct.displayName="isUnset";function Ct(t){return Array.isArray(t)}Ct.displayName="isArray";function Ht(t){if(!nt(t))return!1;let e=w(t.map),n=T(t.length);return t.__proto__===Object.prototype&&n&&!e}Ht.displayName="isArguments";function w(t){return typeof t=="function"}w.displayName="isFunction";function d(t){return typeof t=="string"}d.displayName="isString";function T(t){return typeof t=="number"}T.displayName="isNumber";function nt(t){return typeof t=="object"&&t!==null}nt.displayName="isObject";function Ue(t){return t===null||!nt(t)?!1:Object.getPrototypeOf(t)===Object.prototype}Ue.displayName="isPojo";function Fe(t){return d(t)?!0:Ct(t)?t.every(d):!1}Fe.displayName="isTemplateLiteral";function rt(t){function e(n){return n===t}return e.displayName=`isThisValue(${t})`,e}var Be=(t,e,n)=>e(n)?void 0:(e.displayName||e.name)+`(${t}) did not return true`,Le=(t,e,n)=>typeof n===e?void 0:`Argument "${t}" should be a ${e}`,Ge=t=>(e,n)=>{if(n>=t.length)return;let{argName:r,argType:o}=t[n];if(e===void 0)return`Argument undefined: "${r}"`;let a=Array.isArray(o)?o:[o],s=a.map(u=>w(u)?Be(r,u,e):Le(r,u,e)).filter(d);if(a.length>1?s.length>1:s.length)return s.join(`
| `)+`
> typeof ${r} === ${typeof e}(${JSON.stringify(e)})`};function Ve(t){return e=>{let n=Object.entries(e).map(([r,o])=>({argName:r,argType:o}));return r=>(...o)=>{let s=Array.from(o,c=>Ht(c)?Array.from(c):c).flat(1).map(Ge(n)).filter(d);if(!s.length)return;let i=Object.keys(e).join(", ");return`
${t||""}${r}(${i}):
${s.map(c=>`| ${c}`).join(`
`)}`}}}function M(t){return e=>{let n=Object.keys(e),r=Ve(t)(e);return o=>a=>{let s=qe(a,{keys:n});return r(o)(...s)}}}function qe(t,e){let{keys:n}=e;return Array.isArray(n)?n.reduce((r,o)=>[...r,t[o]],[]):Object.values(t)}var He=10,V=[{accounts:[],statements:[],entries:[]}];function $e(t){q(t),x.emit(l.STORE_HYDRATED)}function F(){return V[V.length-1]}F.history=V;F.hydrate=$e;function q(t){V.push(t),V.length>He&&V.shift(),x.emit(l.STORE_UPDATED)}var J=M("store#"),C=null,Ye=J({id:d,accountNumber:d,sortCode:d,name:[d,b],type:[d,b],iban:[d,b],bic:[d,b]})(l.add.ACCOUNTS),ze=J({id:d,accountNumber:[d,b],sortCode:[d,b],name:[d,b],type:[d,b],iban:[d,b],bic:[d,b]})(l.update.ACCOUNTS);x.on(l.add.ACCOUNTS,t=>{let e=F(),n=G(e,r=>{t.forEach(o=>{let a=Ye(o);if(a)throw TypeError(a);let s=r.accounts.find(i=>i.id===o.id);if(s){console.log("Account exists",s);return}r.accounts.push({...o})})});n!==e&&q(n)});x.on(l.update.ACCOUNTS,t=>{let e=[],n=F(),r=G(n,o=>{t.forEach(a=>{let s=ze(a);if(s)throw TypeError(s);let i=o.accounts.find(c=>c.id===a.id);if(!i){e.push(a);return}Object.entries(a).forEach(([c,u])=>{b(u)||(i[c]=u)})})});e.length&&console.log("Not updating unseen accounts: ",e),r!==n&&q(r)});var Je=J({id:d,accountId:d,endDate:T,startDate:[T,b],startBalance:[T,b],endBalance:[T,b]})(l.add.STATEMENTS),Ke=J({id:d,accountId:[d,b],endDate:T,startDate:T,startBalance:T,endBalance:T})(l.update.STATEMENTS);x.on(l.add.STATEMENTS,t=>{let e=[],n=F(),r=G(n,o=>{t.forEach(a=>{let s=Je(a);if(s)throw TypeError(s);let i=o.statements.find(c=>c.id===a.id);if(i){e.push(i);return}o.statements.push({...a})})});e.length&&console.log("Not overwriting existing statements: ",e),r!==n&&q(r)});x.on(l.update.STATEMENTS,t=>{let e=[],n=F(),r=G(n,o=>{t.forEach(a=>{let s=Ke(a);if(s)throw TypeError(s);let i=o.statements.find(c=>c.id===a.id);if(!i){e.push(a);return}Object.entries(a).forEach(([c,u])=>{b(u)||(i[c]=u)})})});e.length&&console.log("Not updating unseen statements: ",e),r!==n&&q(r)});var We=J({id:d,accountId:d,statementId:d,date:T,type:d,payee:d,note:d,debit:T,credit:T,balance:T})(l.add.ENTRIES);x.on(l.add.ENTRIES,t=>{let e=[],n=F(),r=G(n,o=>{t.forEach(a=>{let s=We(a);if(s)throw TypeError(s);let i=o.entries.find(c=>c.id===a.id);if(i){e.push(i);return}o.entries.push({...a})})});e.length&&console.log("Not overwriting existing entries: ",e),r!==n&&q(r)});var I={received:{ACCOUNTS_LIST:"received/hsbc:accounts-list",STATEMENTS_LIST:"received/hsbc:statements-list",STATEMENT_DETAILS:"received/hsbc:statement-details"}};function It(t,e=""){let n=new Date(t);return[n.getFullYear(),_(n.getMonth()+1),_(n.getDate()),_(n.getHours()),_(n.getMinutes()),_(n.getSeconds())].join(e)}function _(t){return t<10?"0"+t:""+t}function $t(t){return document.cookie.split(";").reduce((n,r)=>{let o=r.indexOf("="),a=r.slice(0,o).trim(),s=r.slice(o+1).trim();return{...n,[a]:s}},{})[t]}function Yt(t){let e=t.split(/\s{3,}/),[n,...r]=e.map(o=>o.trim().replace(/ +/g," "));return[n,r.join(" ")]}function ot(t){let e=/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/,n=t.match(e);if(!n){let u=`dateTimeString does not match expected pattern: ${e.toString()}`;throw new TypeError(u)}let[,r,o,a,s,i,c]=n;return Date.UTC(r,o-1,a,s,i,c)}function Xe(){let t=new Date;return t.getMonth()+1+"/"+t.getDate()+"/"+t.getFullYear()+" "+t.getHours()+":"+_(t.getMinutes())+":"+_(t.getSeconds())}function Qe(){let{getJSCDataTimeStamp:t,HSBCGLBL:e}=window;return typeof t=="function"?t():e&&typeof e.hsbcglblform=="function"?e.hsbcglblform()+":"+Xe():null}function H(){return{"Content-type":"application/json","X-HDR-Synchronizer-Token":$t("SYNC_TOKEN"),"X-HDR-jscData":Qe()}}function zt(t=sessionStorage){let{jmespath:e}=obis.deps,{accountselected:n="{}"}=t,r=JSON.parse(n),o=`
    {
      ctryCde: entityIdentifier.ctryCde,
      grpMmbr: entityIdentifier.grpMmbr
    }
  `,{ctryCde:a,grpMmbr:s}=e.search(r,o);return{ctryCde:a||"GB",grpMmbr:s||"HBEU"}}var Ot=M("addStatementDetailInterceptor#");function Jt(){let{addAjaxListener:t,AjaxRequester:e,jmespath:n,messages:r}=obis.deps;return t({name:"rtrvAcctSumm",description:"Parse a list of accounts",rx:/\/accountDataSvc\/rtrvAcctSumm/,onFullResponse:o=>{let{responseText:a}=o,s=JSON.parse(a),i=`
        countriesAccountList[].acctLiteWrapper[].{
          id:                         acctIndex,
          accountHolderName:          acctHldrFulName[0],
          sortCodeAndAccountNumber:   displyID,

          entProdTypCde: entProdTypCde,
          entProdCatCde: entProdCatCde
        }
      `,c=`
        countriesAccountList[].entityID
      `,u=v=>!Ot({id:d,accountHolderName:d,sortCodeAndAccountNumber:d})("validateEntry")(v),f=v=>!Ot({ctryCde:d,grpMmbr:d})("validateEntity")(v),m=n.search(s,i),S=n.search(s,c),g=m.every(u),E=S.every(f);if(!g||!E){let v=`rtrvAcctSumm :: Validation failed: ${m} + ${S}`;r.emit(l.error.ACCOUNTS,new TypeError(v));return}let{ctryCde:h,grpMmbr:p}=S[0],y={ctryCde:h.toLowerCase(),grpMmbr:p},R=m.map(v=>{let{sortCodeAndAccountNumber:$,...A}=v,[ut,W]=$.split(" ");return{...y,...A,sortCode:ut,accountNumber:W}});r.emit(I.received.ACCOUNTS_LIST,R)}}),e({name:"rtrvAcctSumm",description:"Request a list of accounts",method:"post",url:"/gpib/channel/proxy/accountDataSvc/rtrvAcctSumm",setHeaders:H,setPayload:o=>{let a=Ot({ctryCde:d,grpMmbr:d})("AjaxRequester")(o);if(a){let i=`rtrvAcctSumm :: Invalid options: ${a}`;r.emit(l.error.ACCOUNTS,new TypeError(i));return}let s={accountSummaryFilter:{txnTypCdes:[],entityCdes:[{ctryCde:o.ctryCde,grpMmbr:o.grpMmbr}]}};return JSON.stringify(s)}})}var Kt=Ze;function Ze(){let{messages:t}=obis.deps,{on:e,emit:n}=t,r=Jt();function o(){r(zt())}return e(I.received.ACCOUNTS_LIST,a=>{let s=a.map(i=>({id:i.id,accountNumber:i.accountNumber,sortCode:i.sortCode,name:i.accountHolderName,type:i.entProdTypCde,iban:C,bic:C}));n(l.add.ACCOUNTS,s),n(l.got.ACCOUNTS,a)}),{canRequestAccounts:()=>!0,requestAccounts:o}}var st=Mt(Rt());var ne=M("addAccountStatementsInterceptor#");function oe(){let{addAjaxListener:t,AjaxRequester:e,jmespath:n,messages:r}=obis.deps;return t({name:"rtrvStmtAcctList",description:"Parse a list of available statements in an account",rx:/\/accountDataSvc\/rtrvStmtAcctList/,onFullResponse:o=>{let{responseText:a}=o,s=JSON.parse(a),i=`
        {
          id:     stmtAcctList[].acctIdr.acctIndex | [0],
          bic:    extensions[?name=='bic'].value   | [0],
          iban:   extensions[?name=='iban'].value  | [0],

          entProdCatCde: stmtAcctList[].acctIdr.entProdCatCde | [0],
          entProdTypCde: stmtAcctList[].acctIdr.entProdTypCde | [0],

          startSheet: stmtAcctList[].startSheet | [0],
          statementIds: stmtAcctList[].stmts[?stmtType=='BASE'][].{
            id:       stmtPart[].partId | [0],
            endDate:  stmtEndDt
          }
        }
      `,c=m=>!ne({id:d,bic:d,iban:d,entProdCatCde:d,entProdTypCde:d,startSheet:T,statementIds:re})("validateEntries")(m),u=n.search(s,i);if(!c(u)){let m=`rtrvStmtAcctList :: Validation failed: ${u}`;r.emit(l.error.STATEMENTS,new TypeError(m));return}r.emit(I.received.STATEMENTS_LIST,[u])}}),e({name:"rtrvStmtAcctList",description:"Request a list of available statements in an account",method:"post",url:"/gpib/channel/proxy/accountDataSvc/rtrvStmtAcctList",setHeaders:H,setPayload:o=>{let a=ne({ctryCde:d,grpMmbr:d,year:[rt("Latest"),d],acctIndex:d,entProdTypCde:d,entProdCatCde:d})("AjaxRequester")(o);if(a){let i=`rtrvStmtAcctList :: Invalid options: ${a}`;r.emit(l.error.STATEMENTS,new TypeError(i));return}let s={extensions:[{name:"date",value:o.year||"Latest"}],custIdr:{entityID:{ctryCde:o.ctryCde,grpMmbr:o.grpMmbr},custID:" "},account:[{acctIdr:{acctIndex:o.acctIndex,entProdTypCde:o.entProdTypCde,entProdCatCde:o.entProdCatCde},procFlag:" ",eStmFlag:" ",emailId:" "}]};return JSON.stringify(s)}})}function re(...t){return t.every(({id:e,endDate:n})=>typeof e=="string"&&typeof n=="string")}re.displayName="isValidStatementIds";var ae=En;function yn(t,e=["Latest"]){return e.map(n=>t.map(r=>({year:n,acctIndex:r.id,ctryCde:r.ctryCde,grpMmbr:r.grpMmbr,entProdTypCde:r.entProdTypCde,entProdCatCde:r.entProdCatCde})))}function En(){let{messages:t}=obis.deps,{on:e,emit:n}=t,r=oe(),o=[];e(l.got.ACCOUNTS,i=>{o.push(...i)});function a(i,c){n(l.ui.UPDATE_PROGRESS_BAR,{max:i,value:c})}function s(i=["Latest"]){let c=yn(o,i).flat().map(m=>()=>{let[S,g,E]=(0,st.makePromise)(),h=e(I.received.STATEMENTS_LIST,g),p=e(l.error.STATEMENTS,E);return r(m),a(c.length,++u),S.finally(()=>{h(),p()})}),u=0;a(c.length,u),(0,st.poolPromises)(1,...c).then(m=>{let S=m.filter(h=>h.status==="fulfilled").map(h=>h.value[0]);if(!S.length){let h=m.filter(p=>p.status==="rejected").map(p=>p.reason);n(l.error.STATEMENTS,h);return}let g=S.map(h=>({id:h.id,iban:h.iban,bic:h.bic,accountNumber:C,sortCode:C,name:C,type:C})),E=S.map(h=>h.statementIds.map(p=>({id:p.id,accountId:h.id,endDate:new Date(p.endDate).getTime(),startDate:C,startBalance:C,endBalance:C}))).flat();n(l.update.ACCOUNTS,g),n(l.add.STATEMENTS,E),n(l.got.STATEMENTS),o.length=0})}return{canRequestStatements:()=>!!o.length,requestStatements:s}}var ct=Mt(Rt());function j(t){return!t||typeof t!="number"?"-":(t/100).toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}var{SparkMD5:vn}=obis.deps;function ie(t){return vn.hash(t)}function ce(t){let{date:e,debit:n,credit:r,index:o,accountNumber:a,sortCode:s,type:i,payee:c,note:u}=t,f=It(e)||"UNKNOWN_DATE",m=j(n+r);return f+"_"+ie(f+(o!==void 0?o:"")+(a||"")+(s||"")+(i||"")+(c||"")+(u||"")+m)}var it=M("addStatementDetailInterceptor#");function ue(){let{addAjaxListener:t,AjaxRequester:e,jmespath:n,messages:r}=obis.deps;return t({name:"rtrvStmtDetl",description:"Parse a statement part",rx:/\/accountDataSvc\/rtrvStmtDetl/,onFullResponse:o=>{let{data:a="{}",responseText:s}=o,i=JSON.parse(a),c=JSON.parse(s),u=`
        {
          accountId: acctIdr.acctIndex,
          statementId: stmtDtl.stmtId
        }
      `,f=n.search(i,u),m=it({accountId:d,statementId:d})("ids")(f);if(m){let A=`rtrvStmtDetl :: Validation failed: ${m}`;r.emit(l.error.ENTRIES,new TypeError(A));return}let S=`
        stmtInfo.{
          startDate:      stmtPrdDetl.stmtPrdStrtDt,
          endDate:        stmtPrdDetl.stmtPrdEndDt,
          endBalance:     stmtStartBal.amt,
          startBalance:   stmtEndBal.amt
        }
      `,g=n.search(c,S),E=it({startDate:d,startBalance:T,endDate:d,endBalance:T})("balances")(g);if(E){let A=`rtrvStmtDetl :: Validation failed: ${E}`;r.emit(l.error.ENTRIES,new TypeError(A));return}let h=`
        stmtInfo.stmtTxnDetl[].{
          fullDescription:   txnDetail[0],
          amount:            txnAmt.amt,
          runningBalance:    balRunAmt.amt,
          date:              txnDt
        }
      `,p=A=>!it({date:d,fullDescription:d,amount:T,runningBalance:[T,rt(null)]})("validateEntry")(A),y=n.search(c,h);if(!y.every(p)){let A=`rtrvStmtDetl :: Validation failed: ${y}`;r.emit(l.error.ENTRIES,new TypeError(A));return}let v={...f,startDate:ot(g.startDate),endDate:ot(g.endDate),startBalance:Math.round(g.startBalance*100),endBalance:Math.round(g.endBalance*100)},$=y.map(A=>{let{fullDescription:ut,amount:W,runningBalance:le,date:fe}=A,[pe,me]=Yt(ut),he=Math.round(Math.abs(Math.min(W,0))*100),Se=Math.round(Math.max(W,0)*100),ge=Math.round(le*100),xt={...f,payee:pe,note:me,date:ot(fe),debit:he,credit:Se,balance:ge};return{id:ce(xt),...xt}});r.emit(I.received.STATEMENT_DETAILS,{balances:v,entries:$})}}),e({name:"rtrvStmtDetl",description:"Request a statement part",method:"post",url:"/gpib/channel/proxy/accountDataSvc/rtrvStmtDetl",setHeaders:H,setPayload:o=>{let a=it({entProdTypCde:d,acctIndex:d,startSheet:T,stmtId:d,stmtDt:d})("AjaxRequester")(o);if(a){let i=`rtrvStmtDetl :: Invalid options: ${a}`;r.emit(l.error.ENTRIES,new TypeError(i));return}let s={acctIdr:{acctIndex:o.acctIndex,entProdTypCde:o.entProdTypCde},startSheet:o.startSheet,bulkKey:0,bulkKeyNum:0,stmtDtl:{stmtId:o.stmtId,stmtDt:o.stmtDt,stmtType:"undefined"},pagingInfo:{},extensions:[{name:" ",value:"1"},{name:" ",value:"1"},{name:" ",value:"1"}]};return JSON.stringify(s)}})}var de=An;function Nn(t){return t.map(e=>e.statementIds.map(n=>({entProdTypCde:e.entProdTypCde,acctIndex:e.id,startSheet:e.startSheet,stmtId:n.id,stmtDt:n.endDate})))}function An(){let{messages:t}=obis.deps,{on:e,emit:n}=t,r=ue(),o=[];e(I.received.STATEMENTS_LIST,i=>{o.push(...i)});function a(i,c){n(l.ui.UPDATE_PROGRESS_BAR,{max:i,value:c})}function s(){let i=Nn(o).flat().map(f=>()=>{let[m,S,g]=(0,ct.makePromise)(),E=e(I.received.STATEMENT_DETAILS,S),h=e(l.error.ENTRIES,g);return r(f),a(i.length,++c),m.finally(()=>{E(),h()})}),c=0;a(i.length,c),(0,ct.poolPromises)(1,...i).then(f=>{let m=f.filter(p=>p.status==="fulfilled").map(p=>p.value);if(!m.length){let p=f.filter(y=>y.status==="rejected").map(y=>y.reason);n(l.error.ENTRIES,p);return}let S=m.map(p=>p.balances),g=m.map(p=>p.entries).flat(),E=S.map(p=>{let{statementId:y,startDate:R,endDate:v,startBalance:$,endBalance:A}=p;return{id:y,accountId:C,endDate:v,startDate:R,startBalance:$,endBalance:A}}),h=g.map(p=>{let R=p.credit+-p.debit<0?"WITHD":"DEP";return{id:p.id,accountId:p.accountId,statementId:p.statementId,date:p.date,type:R,payee:p.payee,note:p.note,debit:p.debit,credit:p.credit,balance:p.balance}});n(l.update.STATEMENTS,E),n(l.add.ENTRIES,h),n(l.got.ENTRIES),o.length=0})}return{canRequestEntries:()=>!!o.length,requestEntries:s}}obis.loadPlugin(()=>{let{requestAccounts:t}=Kt(),{requestStatements:e}=ae(),{requestEntries:n}=de(),r=obis.fetchMachine,{messages:o}=obis.deps,{emit:a}=o,s;return r.performTransitions({"idle -> getting-accounts":{on:l.get.ACCOUNTS,then:i=>{s=i,console.log("requestedYearsToDownload = ",i),t()}},"getting-accounts -> found-accounts":{on:l.got.ACCOUNTS,then:()=>a(l.get.STATEMENTS)},"getting-accounts -> failed-accounts":{on:l.error.ACCOUNTS,then:()=>r.enter("idle")},"found-accounts -> getting-statements":{on:l.get.STATEMENTS,then:()=>{let i=new Date().getFullYear(),c=new Array(s).fill().map((u,f)=>String(i-f));e(c.length?c:["Latest"])}},"getting-statements -> found-statements":{on:l.got.STATEMENTS,then:()=>a(l.get.ENTRIES)},"getting-statements -> failed-statements":{on:l.error.STATEMENTS,then:()=>r.enter("found-accounts")},"found-statements -> getting-entries":{on:l.get.ENTRIES,then:()=>n()},"getting-entries -> found-entries":{on:l.got.ENTRIES,then:()=>{}},"getting-entries -> failed-entries":{on:l.error.ENTRIES,then:()=>r.enter("found-statements")},"found-entries -> download-all":{on:l.ui.DOWNLOAD_STATEMENTS,then:()=>{}},"download-all -> found-entries":{on:l.ui.DOWNLOADED_STATEMENTS,then:()=>{}}}),r.info(),{name:"HSBC"}});})();
