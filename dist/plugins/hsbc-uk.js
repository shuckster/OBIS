(()=>{var ge=Object.create,ut=Object.defineProperty,Te=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty,ye=Object.getOwnPropertyNames,be=Object.getOwnPropertyDescriptor;var ve=t=>ut(t,"__esModule",{value:!0});var wt=(t,e)=>()=>(e||(e={exports:{}},t(e.exports,e)),e.exports);var Ae=(t,e,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of ye(e))!Ee.call(t,r)&&r!=="default"&&ut(t,r,{get:()=>e[r],enumerable:!(n=be(e,r))||n.enumerable});return t},Mt=t=>t&&t.__esModule?t:Ae(ve(ut(t!=null?ge(Te(t)):{},"default",{value:t,enumerable:!0})),t);var Xt=wt((Zn,Jt)=>{Jt.exports={seconds:ze,makeDebouncer:ot,makeThrottler:Je,runAfter:Ke,runOnce:Xe,runFnPeriodically:Kt,makeValueChangeDetector:Pt,makeValueInPredicateDetector:Qe,runFnWhenValueChanges:Ze,Delay:We};function ze(t){return t*1e3}function We(t,e){let[n]=ot(e,t);return(...r)=>n(...r)}function ot(t,e){let n,r=()=>clearTimeout(n);return[(...a)=>{r(),n=setTimeout(e,t,...a)},r]}function Je(t,e){let n=!0,[r,o]=ot(e,()=>n=!0);return[(...i)=>{n&&(n=!1,r(),t(...i))},o]}function Ke(t,e){let[n,r]=ot(t,e);return n(),r}function Xe(t){let e=!0,n=()=>!0,r=(...o)=>{e&&n()&&(e=!1,t(...o))};return r.when=o=>(n=o,r),r}function Kt(t,e=16){let n=()=>clearInterval(r),r=setInterval(t,e,{cleanup:n});return n}function Pt({onChange:t=()=>{},getValueFn:e=()=>NaN,equalityFn:n=(r,o)=>r===o}){let r=e();return(...a)=>{let i=e();if(!n(i,r)){let s=r;r=i,t(i,s,...a)}}}function Qe({onChange:t=()=>{},getValueFn:e=()=>NaN,predicateFn:n=()=>!0}){return Pt({getValueFn:e,onChange:o=>n(o)&&t()})}function Ze({fn:t,getValueFn:e}){let n=Pt({getValueFn:e,onChange:t});return Kt(n,16)}});var Rt=wt((tr,Qt)=>{Qt.exports={isThennable:en,makePromise:J,delay:nn,unzip:tn,makeIdleDetectorWithTimeout:rn,poolPromises:on,runPromisesInSequence:an};var{seconds:sn,runOnce:cn,makeDebouncer:Zt}=Xt();function te(){return[(t,[e,n])=>[[...t[0],e],[...t[1],n]],[[],[]]]}function tn(t){return t.reduce(...te())}function en(t){return t&&typeof t.then=="function"}function J(){let t,e;return[new Promise((r,o)=>{t=r,e=o}),t,e]}function nn(t){let[e,n]=J();return setTimeout(n,t||0),e}function rn(t=()=>{},{withinMs:e=500,timeoutInMs:n=sn(5)}){let[r,o,a]=J(),[i,s]=Zt(o,e),[c,d]=Zt(a,n),f=t(i);return i(),c(),r.finally(()=>{f&&f(),s(),d()})}function on(t,...e){let n=()=>a.forEach(i=>i()),r=dn(t,n),[o,a]=e.map(i=>un(r,i)).reduce(...te());return n(),Promise.allSettled(o)}function un(t,e){let{allowedToStartNext:n,bumpRunCount:r,unbump:o}=t,[a,i,s]=J();return[a,cn(()=>{r(),e().then(i,s).finally(o)}).when(n)]}function dn(t,e){let n=0;return{allowedToStartNext:()=>n<Math.max(1,t),bumpRunCount:()=>e(++n),unbump:()=>e(--n)}}function an(t,...e){let[n,r,o]=J();return e.reduce(ln(o),Promise.resolve(t)).then(r).catch(o),n}function ln(t){return(e,n)=>e.then(n,t)}});var l={FIRST_RUN:"first-run",STORE_HYDRATED:"ui/store-hydrated",STORE_UPDATED:"ui/store-updated",ui:{RENDERING:"ui/rendering",RENDERED:"ui/rendered",TOGGLE_OPEN:"ui/toggle-open",FIND_ACCOUNTS:"ui/find-accounts",FIND_STATEMENTS:"ui/find-statements",VIEW_STATEMENTS:"ui/view-statements",DOWNLOAD_STATEMENTS:"ui/download-statements",DOWNLOADED_STATEMENTS:"ui/downloaded-statements",UPDATE_PROGRESS_BAR:"ui/update-progress-bar",STATEMENTS_WINDOW_READY:"ui/statements-window-ready",STATEMENTS_WINDOW_CLOSED:"ui/statements-window-closed",CLOSE_STATEMENTS_WINDOW:"ui/close-statements-window",CHANGE_STATEMENT:"ui/change-statement"},get:{ACCOUNTS:"get/accounts",STATEMENTS:"get/statements",ENTRIES:"get/entries"},error:{ACCOUNTS:"error/accounts",STATEMENTS:"error/statements",ENTRIES:"error/entries"},got:{ACCOUNTS:"got/accounts",STATEMENTS:"got/statements",ENTRIES:"got/entries"},add:{ACCOUNTS:"add/accounts",STATEMENTS:"add/statements",ENTRIES:"add/entries"},update:{ACCOUNTS:"update/accounts",STATEMENTS:"update/statements",ENTRIES:"update/entries"}};function O(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];if(!1)var o,a;throw Error("[Immer] minified error nr: "+t+(n.length?" "+n.map(function(i){return"'"+i+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function L(t){return!!t&&!!t[A]}function j(t){return!!t&&(function(e){if(!e||typeof e!="object")return!1;var n=Object.getPrototypeOf(e);return!n||n===Object.prototype}(t)||Array.isArray(t)||!!t[jt]||!!t.constructor[jt]||dt(t)||lt(t))}function Y(t,e,n){n===void 0&&(n=!1),F(t)===0?(n?Object.keys:ft)(t).forEach(function(r){n&&typeof r=="symbol"||e(r,t[r],t)}):t.forEach(function(r,o){return e(o,r,t)})}function F(t){var e=t[A];return e?e.i>3?e.i-4:e.i:Array.isArray(t)?1:dt(t)?2:lt(t)?3:0}function pt(t,e){return F(t)===2?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function Ne(t,e){return F(t)===2?t.get(e):t[e]}function _t(t,e,n){var r=F(t);r===2?t.set(e,n):r===3?(t.delete(e),t.add(n)):t[e]=n}function De(t,e){return t===e?t!==0||1/t==1/e:t!=t&&e!=e}function dt(t){return Ce&&t instanceof Map}function lt(t){return Ie&&t instanceof Set}function _(t){return t.o||t.t}function mt(t){if(Array.isArray(t))return Array.prototype.slice.call(t);var e=Oe(t);delete e[A];for(var n=ft(e),r=0;r<n.length;r++){var o=n[r],a=e[o];a.writable===!1&&(a.writable=!0,a.configurable=!0),(a.get||a.set)&&(e[o]={configurable:!0,writable:!0,enumerable:a.enumerable,value:t[o]})}return Object.create(Object.getPrototypeOf(t),e)}function ht(t,e){return e===void 0&&(e=!1),St(t)||L(t)||!j(t)||(F(t)>1&&(t.set=t.add=t.clear=t.delete=Pe),Object.freeze(t),e&&Y(t,function(n,r){return ht(r,!0)},!0)),t}function Pe(){O(2)}function St(t){return t==null||typeof t!="object"||Object.isFrozen(t)}function P(t){var e=Re[t];return e||O(18,t),e}function kt(){return z}function gt(t,e){e&&(P("Patches"),t.u=[],t.s=[],t.v=e)}function X(t){Tt(t),t.p.forEach(xe),t.p=null}function Tt(t){t===z&&(z=t.l)}function Ut(t){return z={p:[],l:z,h:t,m:!0,_:0}}function xe(t){var e=t[A];e.i===0||e.i===1?e.j():e.g=!0}function Et(t,e){e._=e.p.length;var n=e.p[0],r=t!==void 0&&t!==n;return e.h.O||P("ES5").S(e,t,r),r?(n[A].P&&(X(e),O(4)),j(t)&&(t=Q(e,t),e.l||Z(e,t)),e.u&&P("Patches").M(n[A],t,e.u,e.s)):t=Q(e,n,[]),X(e),e.u&&e.v(e.u,e.s),t!==Bt?t:void 0}function Q(t,e,n){if(St(e))return e;var r=e[A];if(!r)return Y(e,function(a,i){return Lt(t,r,e,a,i,n)},!0),e;if(r.A!==t)return e;if(!r.P)return Z(t,r.t,!0),r.t;if(!r.I){r.I=!0,r.A._--;var o=r.i===4||r.i===5?r.o=mt(r.k):r.o;Y(r.i===3?new Set(o):o,function(a,i){return Lt(t,r,o,a,i,n)}),Z(t,o,!1),n&&t.u&&P("Patches").R(r,n,t.u,t.s)}return r.o}function Lt(t,e,n,r,o,a){if(L(o)){var i=Q(t,o,a&&e&&e.i!==3&&!pt(e.D,r)?a.concat(r):void 0);if(_t(n,r,i),!L(i))return;t.m=!1}if(j(o)&&!St(o)){if(!t.h.N&&t._<1)return;Q(t,o),e&&e.A.l||Z(t,o)}}function Z(t,e,n){n===void 0&&(n=!1),t.h.N&&t.m&&ht(e,n)}function yt(t,e){var n=t[A];return(n?_(n):t)[e]}function Ft(t,e){if(e in t)for(var n=Object.getPrototypeOf(t);n;){var r=Object.getOwnPropertyDescriptor(n,e);if(r)return r;n=Object.getPrototypeOf(n)}}function bt(t){t.P||(t.P=!0,t.l&&bt(t.l))}function vt(t){t.o||(t.o=mt(t.t))}function At(t,e,n){var r=dt(e)?P("MapSet").T(e,n):lt(e)?P("MapSet").F(e,n):t.O?function(o,a){var i=Array.isArray(o),s={i:i?1:0,A:a?a.A:kt(),P:!1,I:!1,D:{},l:a,t:o,k:null,o:null,j:null,C:!1},c=s,d=tt;i&&(c=[s],d=et);var f=Proxy.revocable(c,d),p=f.revoke,S=f.proxy;return s.k=S,s.j=p,S}(e,n):P("ES5").J(e,n);return(n?n.A:kt()).p.push(r),r}function we(t){return L(t)||O(22,t),function e(n){if(!j(n))return n;var r,o=n[A],a=F(n);if(o){if(!o.P&&(o.i<4||!P("ES5").K(o)))return o.t;o.I=!0,r=Gt(n,a),o.I=!1}else r=Gt(n,a);return Y(r,function(i,s){o&&Ne(o.t,i)===s||_t(r,i,e(s))}),a===3?new Set(r):r}(t)}function Gt(t,e){switch(e){case 2:return new Map(t);case 3:return Array.from(t)}return mt(t)}var Vt,z,Nt=typeof Symbol!="undefined"&&typeof Symbol("x")=="symbol",Ce=typeof Map!="undefined",Ie=typeof Set!="undefined",qt=typeof Proxy!="undefined"&&Proxy.revocable!==void 0&&typeof Reflect!="undefined",Bt=Nt?Symbol.for("immer-nothing"):((Vt={})["immer-nothing"]=!0,Vt),jt=Nt?Symbol.for("immer-draftable"):"__$immer_draftable",A=Nt?Symbol.for("immer-state"):"__$immer_state",vn=typeof Symbol!="undefined"&&Symbol.iterator||"@@iterator";var ft=typeof Reflect!="undefined"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:Object.getOwnPropertyNames,Oe=Object.getOwnPropertyDescriptors||function(t){var e={};return ft(t).forEach(function(n){e[n]=Object.getOwnPropertyDescriptor(t,n)}),e},Re={},tt={get:function(t,e){if(e===A)return t;var n=_(t);if(!pt(n,e))return function(o,a,i){var s,c=Ft(a,i);return c?"value"in c?c.value:(s=c.get)===null||s===void 0?void 0:s.call(o.k):void 0}(t,n,e);var r=n[e];return t.I||!j(r)?r:r===yt(t.t,e)?(vt(t),t.o[e]=At(t.A.h,r,t)):r},has:function(t,e){return e in _(t)},ownKeys:function(t){return Reflect.ownKeys(_(t))},set:function(t,e,n){var r=Ft(_(t),e);if(r==null?void 0:r.set)return r.set.call(t.k,n),!0;if(!t.P){var o=yt(_(t),e),a=o==null?void 0:o[A];if(a&&a.t===n)return t.o[e]=n,t.D[e]=!1,!0;if(De(n,o)&&(n!==void 0||pt(t.t,e)))return!0;vt(t),bt(t)}return t.o[e]=n,t.D[e]=!0,!0},deleteProperty:function(t,e){return yt(t.t,e)!==void 0||e in t.t?(t.D[e]=!1,vt(t),bt(t)):delete t.D[e],t.o&&delete t.o[e],!0},getOwnPropertyDescriptor:function(t,e){var n=_(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r&&{writable:!0,configurable:t.i!==1||e!=="length",enumerable:r.enumerable,value:n[e]}},defineProperty:function(){O(11)},getPrototypeOf:function(t){return Object.getPrototypeOf(t.t)},setPrototypeOf:function(){O(12)}},et={};Y(tt,function(t,e){et[t]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}}),et.deleteProperty=function(t,e){return tt.deleteProperty.call(this,t[0],e)},et.set=function(t,e,n){return tt.set.call(this,t[0],e,n,t[0])};var Me=function(){function t(n){this.O=qt,this.N=!0,typeof(n==null?void 0:n.useProxies)=="boolean"&&this.setUseProxies(n.useProxies),typeof(n==null?void 0:n.autoFreeze)=="boolean"&&this.setAutoFreeze(n.autoFreeze),this.produce=this.produce.bind(this),this.produceWithPatches=this.produceWithPatches.bind(this)}var e=t.prototype;return e.produce=function(n,r,o){if(typeof n=="function"&&typeof r!="function"){var a=r;r=n;var i=this;return function(p){var S=this;p===void 0&&(p=a);for(var g=arguments.length,E=Array(g>1?g-1:0),h=1;h<g;h++)E[h-1]=arguments[h];return i.produce(p,function(m){var b;return(b=r).call.apply(b,[S,m].concat(E))})}}var s;if(typeof r!="function"&&O(6),o!==void 0&&typeof o!="function"&&O(7),j(n)){var c=Ut(this),d=At(this,n,void 0),f=!0;try{s=r(d),f=!1}finally{f?X(c):Tt(c)}return typeof Promise!="undefined"&&s instanceof Promise?s.then(function(p){return gt(c,o),Et(p,c)},function(p){throw X(c),p}):(gt(c,o),Et(s,c))}if(!n||typeof n!="object")return(s=r(n))===Bt?void 0:(s===void 0&&(s=n),this.N&&ht(s,!0),s);O(21,n)},e.produceWithPatches=function(n,r){var o,a,i=this;return typeof n=="function"?function(s){for(var c=arguments.length,d=Array(c>1?c-1:0),f=1;f<c;f++)d[f-1]=arguments[f];return i.produceWithPatches(s,function(p){return n.apply(void 0,[p].concat(d))})}:[this.produce(n,r,function(s,c){o=s,a=c}),o,a]},e.createDraft=function(n){j(n)||O(8),L(n)&&(n=we(n));var r=Ut(this),o=At(this,n,void 0);return o[A].C=!0,Tt(r),o},e.finishDraft=function(n,r){var o=n&&n[A],a=o.A;return gt(a,r),Et(void 0,a)},e.setAutoFreeze=function(n){this.N=n},e.setUseProxies=function(n){n&&!qt&&O(20),this.O=n},e.applyPatches=function(n,r){var o;for(o=r.length-1;o>=0;o--){var a=r[o];if(a.path.length===0&&a.op==="replace"){n=a.value;break}}var i=P("Patches").$;return L(n)?i(n,r):this.produce(n,function(s){return i(s,r.slice(o+1))})},t}(),N=new Me,G=N.produce,An=N.produceWithPatches.bind(N),Nn=N.setAutoFreeze.bind(N),Dn=N.setUseProxies.bind(N),Cn=N.applyPatches.bind(N),In=N.createDraft.bind(N),On=N.finishDraft.bind(N);(function(){if(typeof window.CustomEvent=="function")return!1;function t(e,n){n=n||{bubbles:!1,cancelable:!1,detail:null};let r=document.createEvent("CustomEvent");return r.initCustomEvent(e,n.bubbles,n.cancelable,n.detail),r}window.CustomEvent=t})();var R=function(){let t;try{t=window}catch(c){t=self}let e="message-bus",n=new Map;function r(c,...d){let f={eventName:c,args:d,timestamp:Date.now()},p=new CustomEvent(e,{detail:f});t.dispatchEvent(p)}function o(c,d){if(typeof d!="function")throw new TypeError("Callback is not a function");let f=n.has(c)?n.get(c):n.set(c,new Map).get(c);if(f.has(d))throw new Error("Callback already deals with this event");let p=typeof c=="string"&&c.indexOf("*")===-1,S=typeof c=="string"?i(c):c instanceof RegExp?c:null;if(S===null){let E="Could not figure-out eventNameOrPattern";throw new Error(`${E} = ${c}`)}let g=E=>{let{eventName:h,args:m}=E.detail;S.test(h)&&(p?d(...m):d(h,...m))};return f.set(d,g),t.addEventListener(e,g),()=>a(c,d)}function a(c,d){if(typeof d!="function")throw new TypeError("Callback is not a function");if(!n.has(c))throw new Error("No event-listener for that name/pattern");let f=n.get(c);if(!f.has(d))throw new Error("Event callback not found for name/pattern");let p=f.get(d);t.removeEventListener(e,p),f.delete(d)}function i(c){if(!c.length)throw new Error("String should not be empty");let d=c.split("*").map(p=>p.trim()).map(s),f=d.join(".*");return d.length===1?f=`^${f}$`:(d[0]!==""&&(f=`^${f}`),d[d.length-1]!==""&&(f=`${f}$`)),new RegExp(f)}function s(c){return c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return{emit:r,on:o,off:a}}();function je(t){return Dt(t)&&k(t.emit)&&(k(t.addListener)||k(t.on))&&(k(t.removeListener)||k(t.off))}je.displayName="isEventEmitter";function y(t){return t==null}Ct.displayName="isUnset";function Ct(t){return Array.isArray(t)}Ct.displayName="isArray";function k(t){return typeof t=="function"}k.displayName="isFunction";function u(t){return typeof t=="string"}u.displayName="isString";function T(t){return typeof t=="number"}T.displayName="isNumber";function Dt(t){return typeof t=="object"}Dt.displayName="isObject";function _e(t){return t===null||!Dt(t)?!1:Object.getPrototypeOf(t)===Object.prototype}_e.displayName="isPojo";function ke(t){return u(t)?!0:Ct(t)?t.every(u):!1}ke.displayName="isTemplateLiteral";function nt(t){function e(n){return n===t}return e.displayName=`isThisValue(${t})`,e}var Ue=(t,e,n)=>e(n)?void 0:`${e.displayName||e.name}(${t}) did not return true`,Be=(t,e,n)=>typeof n===e?void 0:`Argument "${t}" should be a ${e}`,Le=(t,e,n)=>{let{argName:r,argType:o}=t[n];if(e===void 0)return`Argument undefined: "${r}"`;let a=Array.isArray(o)?o:[o],i=a.map(d=>k(d)?Ue(r,d,e):Be(r,d,e)).filter(u);if(a.length>1?i.length>1:i.length)return`${i.join(`
| `)}
> typeof ${r} === ${typeof e}(${JSON.stringify(e)})`};function Fe(t){return(e,n,...r)=>{let o=Object.entries(n).map(([s,c])=>({argName:s,argType:c})),a=r.map((...s)=>Le(o,...s)).filter(u);if(!a.length)return;let i=Object.keys(n).join(", ");return`
${t||""}${e}(${i}):
${a.map(s=>`| ${s}`).join(`
`)}`}}function x(t){let e=Fe(t);return(n,r,o)=>{let a=Object.keys(r),i=Ge(o,{keys:a});return e(n,r,...i)}}function Ge(t,e){let{keys:n}=e;return Array.isArray(n)?n.reduce((r,o)=>[...r,t[o]],[]):Object.values(t)}var Ve=10,V=[{accounts:[],statements:[],entries:[]}];function qe(t){q(t),R.emit(l.STORE_HYDRATED)}function U(){return V[V.length-1]}U.history=V;U.hydrate=qe;function q(t){V.push(t),V.length>Ve&&V.shift(),R.emit(l.STORE_UPDATED)}var W=x("store#"),D=null;R.on(l.add.ACCOUNTS,t=>{let e=U(),n=G(e,r=>{t.forEach(o=>{let a=W(l.add.ACCOUNTS,{id:u,accountNumber:u,sortCode:u,name:[u,y],type:[u,y],iban:[u,y],bic:[u,y]},o);if(a)throw TypeError(a);let i=r.accounts.find(s=>s.id===o.id);if(i){console.log("Account exists",i);return}r.accounts.push({...o})})});n!==e&&q(n)});R.on(l.update.ACCOUNTS,t=>{let e=[],n=U(),r=G(n,o=>{t.forEach(a=>{let i=W(l.update.ACCOUNTS,{id:u,accountNumber:[u,y],sortCode:[u,y],name:[u,y],type:[u,y],iban:[u,y],bic:[u,y]},a);if(i)throw TypeError(i);let s=o.accounts.find(c=>c.id===a.id);if(!s){e.push(a);return}Object.entries(a).forEach(([c,d])=>{y(d)||(s[c]=d)})})});e.length&&console.log("Not updating unseen accounts: ",e),r!==n&&q(r)});R.on(l.add.STATEMENTS,t=>{let e=[],n=U(),r=G(n,o=>{t.forEach(a=>{let i=W(l.add.STATEMENTS,{id:u,accountId:u,endDate:T,startDate:[T,y],startBalance:[T,y],endBalance:[T,y]},a);if(i)throw TypeError(i);let s=o.statements.find(c=>c.id===a.id);if(s){e.push(s);return}o.statements.push({...a})})});e.length&&console.log("Not overwriting existing statements: ",e),r!==n&&q(r)});R.on(l.update.STATEMENTS,t=>{let e=[],n=U(),r=G(n,o=>{t.forEach(a=>{let i=W(l.update.STATEMENTS,{id:u,accountId:[u,y],endDate:T,startDate:T,startBalance:T,endBalance:T},a);if(i)throw TypeError(i);let s=o.statements.find(c=>c.id===a.id);if(!s){e.push(a);return}Object.entries(a).forEach(([c,d])=>{y(d)||(s[c]=d)})})});e.length&&console.log("Not updating unseen statements: ",e),r!==n&&q(r)});R.on(l.add.ENTRIES,t=>{let e=[],n=U(),r=G(n,o=>{t.forEach(a=>{let i=W(l.add.ENTRIES,{id:u,accountId:u,statementId:u,date:T,type:u,payee:u,note:u,debit:T,credit:T,balance:T},a);if(i)throw TypeError(i);let s=o.entries.find(c=>c.id===a.id);if(s){e.push(s);return}o.entries.push({...a})})});e.length&&console.log("Not overwriting existing entries: ",e),r!==n&&q(r)});var C={received:{ACCOUNTS_LIST:"received/hsbc:accounts-list",STATEMENTS_LIST:"received/hsbc:statements-list",STATEMENT_DETAILS:"received/hsbc:statement-details"}};function It(t,e=""){let n=new Date(t);return[n.getFullYear(),w(n.getMonth()+1),w(n.getDate()),w(n.getHours()),w(n.getMinutes()),w(n.getSeconds())].join(e)}function w(t){return t<10?"0"+t:""+t}function Ht(t){return document.cookie.split(";").reduce((n,r)=>{let o=r.indexOf("="),a=r.slice(0,o).trim(),i=r.slice(o+1).trim();return{...n,[a]:i}},{})[t]}function $t(t){let e=t.split(/\s{3,}/),[n,...r]=e.map(o=>o.trim().replace(/ +/g," "));return[n,r.join(" ")]}function rt(t){let e=/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/,n=t.match(e);if(!n){let d=`dateTimeString does not match expected pattern: ${e.toString()}`;throw new TypeError(d)}let[,r,o,a,i,s,c]=n;return Date.UTC(r,o-1,a,i,s,c)}function He(){let t=new Date;return t.getMonth()+1+"/"+t.getDate()+"/"+t.getFullYear()+" "+t.getHours()+":"+w(t.getMinutes())+":"+w(t.getSeconds())}function $e(){let{getJSCDataTimeStamp:t,HSBCGLBL:e}=window;return typeof t=="function"?t():e&&typeof e.hsbcglblform=="function"?e.hsbcglblform()+":"+He():null}function H(){return{"Content-type":"application/json","X-HDR-Synchronizer-Token":Ht("SYNC_TOKEN"),"X-HDR-jscData":$e()}}function Yt(t=sessionStorage){let{jmespath:e}=obis.deps,{accountselected:n="{}"}=t,r=JSON.parse(n),o=`
    {
      ctryCde: entityIdentifier.ctryCde,
      grpMmbr: entityIdentifier.grpMmbr
    }
  `,{ctryCde:a,grpMmbr:i}=e.search(r,o);return{ctryCde:a||"GB",grpMmbr:i||"HBEU"}}var Ot=x("addStatementDetailInterceptor#");function zt(){let{addAjaxListener:t,AjaxRequester:e,jmespath:n,messages:r}=obis.deps;return t({name:"rtrvAcctSumm",description:"Parse a list of accounts",rx:/\/accountDataSvc\/rtrvAcctSumm/,onFullResponse:o=>{let{responseText:a}=o,i=JSON.parse(a),s=`
        countriesAccountList[].acctLiteWrapper[].{
          id:                         acctIndex,
          accountHolderName:          acctHldrFulName[0],
          sortCodeAndAccountNumber:   displyID,

          entProdTypCde: entProdTypCde,
          entProdCatCde: entProdCatCde
        }
      `,c=`
        countriesAccountList[].entityID
      `,d=I=>!Ot("validateEntry",{id:u,accountHolderName:u,sortCodeAndAccountNumber:u},I),f=I=>!Ot("validateEntry",{ctryCde:u,grpMmbr:u},I),p=n.search(i,s),S=n.search(i,c),g=p.every(d),E=S.every(f);if(!g||!E){let I=`rtrvAcctSumm :: Validation failed: ${p} + ${S}`;r.emit(l.error.ACCOUNTS,new TypeError(I));return}let{ctryCde:h,grpMmbr:m}=S[0],b={ctryCde:h.toLowerCase(),grpMmbr:m},B=p.map(I=>{let{sortCodeAndAccountNumber:$,...v}=I,[ct,K]=$.split(" ");return{...b,...v,sortCode:ct,accountNumber:K}});r.emit(C.received.ACCOUNTS_LIST,B)}}),e({name:"rtrvAcctSumm",description:"Request a list of accounts",method:"post",url:"/gpib/channel/proxy/accountDataSvc/rtrvAcctSumm",setHeaders:H,setPayload:o=>{let a=Ot("AjaxRequester",{ctryCde:u,grpMmbr:u},o);if(a){let s=`rtrvAcctSumm :: Invalid options: ${a}`;r.emit(l.error.ACCOUNTS,new TypeError(s));return}let i={accountSummaryFilter:{txnTypCdes:[],entityCdes:[{ctryCde:o.ctryCde,grpMmbr:o.grpMmbr}]}};return JSON.stringify(i)}})}var Wt=Ye;function Ye(){let{messages:t}=obis.deps,{on:e,emit:n}=t,r=zt();function o(){r(Yt())}return e(C.received.ACCOUNTS_LIST,a=>{let i=a.map(s=>({id:s.id,accountNumber:s.accountNumber,sortCode:s.sortCode,name:s.accountHolderName,type:s.entProdTypCde,iban:D,bic:D}));n(l.add.ACCOUNTS,i),n(l.got.ACCOUNTS,a)}),{canRequestAccounts:()=>!0,requestAccounts:o}}var at=Mt(Rt());var ee=x("addAccountStatementsInterceptor#");function re(){let{addAjaxListener:t,AjaxRequester:e,jmespath:n,messages:r}=obis.deps;return t({name:"rtrvStmtAcctList",description:"Parse a list of available statements in an account",rx:/\/accountDataSvc\/rtrvStmtAcctList/,onFullResponse:o=>{let{responseText:a}=o,i=JSON.parse(a),s=`
        {
          id:     stmtAcctList[].acctIdr.acctIndex | [0],
          bic:    extensions[?name=='bic'].value   | [0],
          iban:   extensions[?name=='iban'].value  | [0],

          entProdCatCde: stmtAcctList[].acctIdr.entProdCatCde | [0],
          entProdTypCde: stmtAcctList[].acctIdr.entProdTypCde | [0],

          startSheet: stmtAcctList[].startSheet | [0],
          statementIds: stmtAcctList[].stmts[?stmtType=='BASE'][].{
            id:       stmtPart[].partId | [0],
            endDate:  stmtEndDt
          }
        }
      `,c=p=>!ee("validateEntries",{id:u,bic:u,iban:u,entProdCatCde:u,entProdTypCde:u,startSheet:T,statementIds:ne},p),d=n.search(i,s);if(!c(d)){let p=`rtrvStmtAcctList :: Validation failed: ${d}`;r.emit(l.error.STATEMENTS,new TypeError(p));return}r.emit(C.received.STATEMENTS_LIST,[d])}}),e({name:"rtrvStmtAcctList",description:"Request a list of available statements in an account",method:"post",url:"/gpib/channel/proxy/accountDataSvc/rtrvStmtAcctList",setHeaders:H,setPayload:o=>{let a=ee("AjaxRequester",{ctryCde:u,grpMmbr:u,year:[nt("Latest"),u],acctIndex:u,entProdTypCde:u,entProdCatCde:u},o);if(a){let s=`rtrvStmtAcctList :: Invalid options: ${a}`;r.emit(l.error.STATEMENTS,new TypeError(s));return}let i={extensions:[{name:"date",value:o.year||"Latest"}],custIdr:{entityID:{ctryCde:o.ctryCde,grpMmbr:o.grpMmbr},custID:" "},account:[{acctIdr:{acctIndex:o.acctIndex,entProdTypCde:o.entProdTypCde,entProdCatCde:o.entProdCatCde},procFlag:" ",eStmFlag:" ",emailId:" "}]};return JSON.stringify(i)}})}function ne(t){return t.every(({id:e,endDate:n})=>typeof e=="string"&&typeof n=="string")}ne.displayName="isValidStatementIds";var oe=fn;function pn(t,e=["Latest"]){return e.map(n=>t.map(r=>({year:n,acctIndex:r.id,ctryCde:r.ctryCde,grpMmbr:r.grpMmbr,entProdTypCde:r.entProdTypCde,entProdCatCde:r.entProdCatCde})))}function fn(){let{messages:t}=obis.deps,{on:e,emit:n}=t,r=re(),o=[];e(l.got.ACCOUNTS,s=>{o.push(...s)});function a(s,c){n(l.ui.UPDATE_PROGRESS_BAR,{max:s,value:c})}function i(s=["Latest"]){let c=pn(o,s).flat().map(p=>()=>{let[S,g,E]=at.makePromise(),h=e(C.received.STATEMENTS_LIST,g),m=e(l.error.STATEMENTS,E);return r(p),a(c.length,++d),S.finally(()=>{h(),m()})}),d=0;a(c.length,d),at.poolPromises(1,...c).then(p=>{let S=p.filter(h=>h.status==="fulfilled").map(h=>h.value[0]);if(!S.length){let h=p.filter(m=>m.status==="rejected").map(m=>m.reason);n(l.error.STATEMENTS,h);return}let g=S.map(h=>({id:h.id,iban:h.iban,bic:h.bic,accountNumber:D,sortCode:D,name:D,type:D})),E=S.map(h=>h.statementIds.map(m=>({id:m.id,accountId:h.id,endDate:new Date(m.endDate).getTime(),startDate:D,startBalance:D,endBalance:D}))).flat();n(l.update.ACCOUNTS,g),n(l.add.STATEMENTS,E),n(l.got.STATEMENTS),o.length=0})}return{canRequestStatements:()=>!!o.length,requestStatements:i}}var it=Mt(Rt());function M(t){return!t||typeof t!="number"?"-":(t/100).toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}var{SparkMD5:hn}=obis.deps;function se(t){return hn.hash(t)}function ie(t){let{date:e,debit:n,credit:r,index:o,accountNumber:a,sortCode:i,type:s,payee:c,note:d}=t,f=It(e)||"UNKNOWN_DATE",p=M(n+r);return f+"_"+se(f+(o!==void 0?o:"")+(a||"")+(i||"")+(s||"")+(c||"")+(d||"")+p)}var st=x("addStatementDetailInterceptor#");function ce(){let{addAjaxListener:t,AjaxRequester:e,jmespath:n,messages:r}=obis.deps;return t({name:"rtrvStmtDetl",description:"Parse a statement part",rx:/\/accountDataSvc\/rtrvStmtDetl/,onFullResponse:o=>{let{data:a="{}",responseText:i}=o,s=JSON.parse(a),c=JSON.parse(i),d=`
        {
          accountId: acctIdr.acctIndex,
          statementId: stmtDtl.stmtId
        }
      `,f=n.search(s,d),p=st("ids",{accountId:u,statementId:u},f);if(p){let v=`rtrvStmtDetl :: Validation failed: ${p}`;r.emit(l.error.ENTRIES,new TypeError(v));return}let S=`
        stmtInfo.{
          startDate:      stmtPrdDetl.stmtPrdStrtDt,
          endDate:        stmtPrdDetl.stmtPrdEndDt,
          endBalance:     stmtStartBal.amt,
          startBalance:   stmtEndBal.amt
        }
      `,g=n.search(c,S),E=st("balances",{startDate:u,startBalance:T,endDate:u,endBalance:T},g);if(E){let v=`rtrvStmtDetl :: Validation failed: ${E}`;r.emit(l.error.ENTRIES,new TypeError(v));return}let h=`
        stmtInfo.stmtTxnDetl[].{
          fullDescription:   txnDetail[0],
          amount:            txnAmt.amt,
          runningBalance:    balRunAmt.amt,
          date:              txnDt
        }
      `,m=v=>!st("validateEntry",{date:u,fullDescription:u,amount:T,runningBalance:[T,nt(null)]},v),b=n.search(c,h);if(!b.every(m)){let v=`rtrvStmtDetl :: Validation failed: ${b}`;r.emit(l.error.ENTRIES,new TypeError(v));return}let I={...f,startDate:rt(g.startDate),endDate:rt(g.endDate),startBalance:Math.round(g.startBalance*100),endBalance:Math.round(g.endBalance*100)},$=b.map(v=>{let{fullDescription:ct,amount:K,runningBalance:de,date:le}=v,[fe,pe]=$t(ct),me=Math.round(Math.abs(Math.min(K,0))*100),he=Math.round(Math.max(K,0)*100),Se=Math.round(de*100),xt={...f,payee:fe,note:pe,date:rt(le),debit:me,credit:he,balance:Se};return{id:ie(xt),...xt}});r.emit(C.received.STATEMENT_DETAILS,{balances:I,entries:$})}}),e({name:"rtrvStmtDetl",description:"Request a statement part",method:"post",url:"/gpib/channel/proxy/accountDataSvc/rtrvStmtDetl",setHeaders:H,setPayload:o=>{let a=st("AjaxRequester",{entProdTypCde:u,acctIndex:u,startSheet:T,stmtId:u,stmtDt:u},o);if(a){let s=`rtrvStmtDetl :: Invalid options: ${a}`;r.emit(l.error.ENTRIES,new TypeError(s));return}let i={acctIdr:{acctIndex:o.acctIndex,entProdTypCde:o.entProdTypCde},startSheet:o.startSheet,bulkKey:0,bulkKeyNum:0,stmtDtl:{stmtId:o.stmtId,stmtDt:o.stmtDt,stmtType:"undefined"},pagingInfo:{},extensions:[{name:" ",value:"1"},{name:" ",value:"1"},{name:" ",value:"1"}]};return JSON.stringify(i)}})}var ue=Sn;function gn(t){return t.map(e=>e.statementIds.map(n=>({entProdTypCde:e.entProdTypCde,acctIndex:e.id,startSheet:e.startSheet,stmtId:n.id,stmtDt:n.endDate})))}function Sn(){let{messages:t}=obis.deps,{on:e,emit:n}=t,r=ce(),o=[];e(C.received.STATEMENTS_LIST,s=>{o.push(...s)});function a(s,c){n(l.ui.UPDATE_PROGRESS_BAR,{max:s,value:c})}function i(){let s=gn(o).flat().map(f=>()=>{let[p,S,g]=it.makePromise(),E=e(C.received.STATEMENT_DETAILS,S),h=e(l.error.ENTRIES,g);return r(f),a(s.length,++c),p.finally(()=>{E(),h()})}),c=0;a(s.length,c),it.poolPromises(1,...s).then(f=>{let p=f.filter(m=>m.status==="fulfilled").map(m=>m.value);if(!p.length){let m=f.filter(b=>b.status==="rejected").map(b=>b.reason);n(l.error.ENTRIES,m);return}let S=p.map(m=>m.balances),g=p.map(m=>m.entries).flat(),E=S.map(m=>{let{statementId:b,startDate:B,endDate:I,startBalance:$,endBalance:v}=m;return{id:b,accountId:D,endDate:I,startDate:B,startBalance:$,endBalance:v}}),h=g.map(m=>{let B=m.credit+-m.debit<0?"WITHD":"DEP";return{id:m.id,accountId:m.accountId,statementId:m.statementId,date:m.date,type:B,payee:m.payee,note:m.note,debit:m.debit,credit:m.credit,balance:m.balance}});n(l.update.STATEMENTS,E),n(l.add.ENTRIES,h),n(l.got.ENTRIES),o.length=0})}return{canRequestEntries:()=>!!o.length,requestEntries:i}}obis.loadPlugin(()=>{let{requestAccounts:t}=Wt(),{requestStatements:e}=oe(),{requestEntries:n}=ue(),r=obis.fetchMachine,{messages:o}=obis.deps,{emit:a}=o,i;return r.performTransitions({"idle -> getting-accounts":{on:l.get.ACCOUNTS,then:s=>{i=s,console.log("requestedYearsToDownload = ",s),t()}},"getting-accounts -> found-accounts":{on:l.got.ACCOUNTS,then:()=>a(l.get.STATEMENTS)},"getting-accounts -> failed-accounts":{on:l.error.ACCOUNTS,then:()=>r.enter("idle")},"found-accounts -> getting-statements":{on:l.get.STATEMENTS,then:()=>{let s=new Date().getFullYear(),c=new Array(i).fill().map((d,f)=>String(s-f));e(c.length?c:["Latest"])}},"getting-statements -> found-statements":{on:l.got.STATEMENTS,then:()=>a(l.get.ENTRIES)},"getting-statements -> failed-statements":{on:l.error.STATEMENTS,then:()=>r.enter("found-accounts")},"found-statements -> getting-entries":{on:l.get.ENTRIES,then:()=>n()},"getting-entries -> found-entries":{on:l.got.ENTRIES,then:()=>{}},"getting-entries -> failed-entries":{on:l.error.ENTRIES,then:()=>r.enter("found-statements")},"found-entries -> download-all":{on:l.ui.DOWNLOAD_STATEMENTS,then:()=>{}},"download-all -> found-entries":{on:l.ui.DOWNLOADED_STATEMENTS,then:()=>{}}}),r.info(),{name:"HSBC"}});})();
